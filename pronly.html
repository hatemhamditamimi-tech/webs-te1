<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>حاسبة زمن تجميد الأغذية</title>
  <style>
    :root{
      --bg:#0f172a; /* slate-900 */
      --card:#111827; /* gray-900 */
      --muted:#94a3b8; /* slate-400 */
      --text:#e5e7eb; /* gray-200 */
      --brand:#22d3ee; /* cyan-400 */
      --accent:#a78bfa; /* violet-400 */
      --ok:#34d399; /* green-400 */
      --warn:#fbbf24; /* amber-400 */
      --bad:#f87171; /* red-400 */
      --stroke:#1f2937; /* gray-800 */
    }
    *{box-sizing:border-box}
    body{margin:0;background:linear-gradient(180deg,#0b1022,#0f172a 35%,#0b1022);color:var(--text);font-family:"Tajawal",system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,"Apple Color Emoji","Segoe UI Emoji";}
    .container{max-width:1200px;margin:auto;padding:24px}
    header{display:flex;gap:16px;align-items:center;justify-content:space-between;margin-bottom:16px}
    .title{font-size:clamp(20px,2.6vw,32px);font-weight:800;letter-spacing:.2px}
    .sub{color:var(--muted);font-size:14px}
    .grid{display:grid;grid-template-columns:1.2fr .8fr;gap:16px}
    @media (max-width: 980px){.grid{grid-template-columns:1fr;}}
    .card{background:linear-gradient(180deg,rgba(255,255,255,.02),rgba(255,255,255,.01));border:1px solid var(--stroke);border-radius:20px;box-shadow:0 6px 30px rgba(0,0,0,.25);padding:18px}
    .card h2{margin:0 0 12px;font-size:18px}
    .row{display:grid;grid-template-columns:1fr 1fr;gap:12px}
    .row-3{display:grid;grid-template-columns:repeat(3,1fr);gap:12px}
    .field{display:flex;flex-direction:column;gap:6px}
    .field label{font-size:13px;color:var(--muted)}
    input, select{width:100%;padding:12px 12px;border-radius:12px;border:1px solid var(--stroke);background:#0b1328;color:var(--text);outline:none}
    input:focus, select:focus{border-color:var(--brand);box-shadow:0 0 0 3px rgba(34,211,238,.15)}
    .help{font-size:12px;color:var(--muted)}
    .btns{display:flex;flex-wrap:wrap;gap:10px;margin-top:12px}
    button{border:1px solid var(--stroke);background:#0b1328;color:var(--text);padding:10px 14px;border-radius:12px;cursor:pointer}
    button.primary{background:linear-gradient(135deg,var(--brand),var(--accent));border:none;color:#001119;font-weight:700}
    button.ghost{background:transparent}
    .kpis{display:grid;grid-template-columns:repeat(4,1fr);gap:12px;margin-top:12px}
    @media (max-width: 700px){.kpis{grid-template-columns:repeat(2,1fr)}}
    .kpi{background:#0b1328;border:1px dashed var(--stroke);border-radius:16px;padding:14px}
    .kpi .v{font-size:22px;font-weight:800}
    .kpi .l{font-size:12px;color:var(--muted)}
    .timeline{margin-top:16px;background:#0b1328;border:1px solid var(--stroke);border-radius:14px;padding:14px}
    .bar{position:relative;height:14px;background:#0a0f20;border-radius:999px;border:1px solid var(--stroke);overflow:hidden}
    .seg{position:absolute;top:0;bottom:0}
    .seg.cool{background:linear-gradient(90deg,#60a5fa,#22d3ee)}
    .seg.freeze{background:linear-gradient(90deg,#22d3ee,#a78bfa)}
    .seg.sub{background:linear-gradient(90deg,#a78bfa,#f472b6)}
    .legend{display:flex;gap:10px;flex-wrap:wrap;margin-top:10px;font-size:12px;color:var(--muted)}
    .legend span{display:inline-flex;align-items:center;gap:6px}
    .sw{width:14px;height:8px;border-radius:999px;display:inline-block}
    .tips{font-size:13px;color:var(--muted);line-height:1.7}
    .status{margin-top:10px;font-size:13px}
    .status.good{color:var(--ok)}
    .status.warn{color:var(--warn)}
    .status.bad{color:var(--bad)}
    footer{margin-top:22px;display:flex;gap:8px;align-items:center;justify-content:space-between;color:var(--muted);font-size:12px}
    .pill{display:inline-flex;align-items:center;gap:8px;background:#0b1328;border:1px solid var(--stroke);border-radius:999px;padding:8px 12px}
    .split{display:grid;grid-template-columns:1fr 1fr;gap:12px}
    @media (max-width: 700px){.split{grid-template-columns:1fr}}
    .notice{border-left:4px solid var(--brand);padding:10px 12px;background:#0b1328;border-radius:12px}
  </style>
</head>
<body>
  <div class="container">
    <header>
      <div>
        <div class="title">حاسبة زمن التجميد للأغذية</div>
        <div class="sub">تقدير زمني ذكي يعتمد على خصائص المادة، الشكل الهندسي، وظروف المجمد. النتائج تقريبية لغرض التخطيط الصناعي/المنزلي.</div>
      </div>
      <div class="pill">🔁 <span id="presetLabel">إعدادات افتراضية آمنة</span></div>
    </header>

    <div class="grid">
      <!-- المدخلات -->
      <section class="card">
        <h2>المدخلات</h2>
        <div class="row">
          <div class="field">
            <label>نوع الغذاء</label>
            <select id="food">
              <option value="beef">لحم بقري</option>
              <option value="chicken">دجاج</option>
              <option value="fish">سمك</option>
              <option value="bread">خبز</option>
              <option value="strawberry">فراولة</option>
              <option value="peas">بازلاء</option>
              <option value="icecream">آيس كريم</option>
              <option value="custom">مخصص…</option>
            </select>
            <div class="help">اختر المادة ليتم تحميل الخصائص الحرارية تلقائياً. يمكن تعديلها في تبويب "خصائص المادة".</div>
          </div>
          <div class="field">
            <label>درجة حرارة الهواء داخل المجمد (°م)</label>
            <input id="Tair" type="number" step="0.1" value="-20" />
            <div class="help">عادة بين −18 و −30°م.</div>
          </div>
        </div>

        <div class="row">
          <div class="field">
            <label>درجة حرارة المنتج الحالية (°م)</label>
            <input id="Tinit" type="number" step="0.1" value="5" />
          </div>
          <div class="field">
            <label>الدرجة المستهدفة في قلب المنتج (°م)</label>
            <input id="Ttarget" type="number" step="0.1" value="-18" />
          </div>
        </div>

        <div class="row">
          <div class="field">
            <label>الهندسة</label>
            <select id="shape">
              <option value="slab">شريحة (طول × عرض × سماكة)</option>
              <option value="cylinder">أسطوانة (قطر × ارتفاع)</option>
              <option value="sphere">كرة (قطر)</option>
            </select>
          </div>
          <div class="field">
            <label>وضعية التعبئة/التغليف</label>
            <select id="pack">
              <option value="bare">بدون تغليف/ملامس للهواء</option>
              <option value="wrap">تغليف رقيق (نايلون/كيس)</option>
              <option value="box">علبة/كرتون</option>
            </select>
          </div>
        </div>

        <div id="dims" class="row-3">
          <div class="field slab-only">
            <label>الطول (سم)</label>
            <input id="L" type="number" step="0.1" value="20" />
          </div>
          <div class="field slab-only">
            <label>العرض (سم)</label>
            <input id="W" type="number" step="0.1" value="10" />
          </div>
          <div class="field slab-only">
            <label>السماكة (سم)</label>
            <input id="T" type="number" step="0.1" value="4" />
          </div>
          <div class="field cyl-only" style="display:none">
            <label>القطر (سم)</label>
            <input id="D" type="number" step="0.1" value="10" />
          </div>
          <div class="field cyl-only" style="display:none">
            <label>الارتفاع (سم)</label>
            <input id="H" type="number" step="0.1" value="8" />
          </div>
          <div class="field sph-only" style="display:none">
            <label>قطر الكرة (سم)</label>
            <input id="Ds" type="number" step="0.1" value="8" />
          </div>
        </div>

        <div class="row">
          <div class="field">
            <label>سرعة الهواء/تدفقه</label>
            <select id="airflow">
              <option value="low">منخفض (مجمد منزلي)</option>
              <option value="med" selected>متوسط</option>
              <option value="high">عالٍ (نفق تجميد)</option>
            </select>
          </div>
          <div class="field">
            <label>معامل أمان (٪ زيادة على الزمن)</label>
            <input id="safety" type="number" step="1" value="10" />
          </div>
        </div>

        <div class="btns">
          <button class="primary" id="calc">احسب الزمن</button>
          <button id="reset">إعادة الضبط</button>
          <button class="ghost" id="exportCsv">تصدير النتائج CSV</button>
          <button class="ghost" id="share">نسخ رابط الإعدادات</button>
        </div>

        <div class="notice" style="margin-top:12px">
          ◀️ <strong>ملاحظة نمذجة:</strong> يعتمد الحساب على نموذج مبسّط من ثلاث مراحل (تبريد حتى نقطة التجمد، تجميد طوري، تبريد تحت التجمُّد) باستخدام تقريب الكتلة المتكتلة (lumped) ومعامل انتقال حراري تقديري حسب تدفق الهواء والتعبئة. النتائج إرشادية وليست بديلاً عن قياس حرارة النواة بالمسبار.
        </div>
      </section>

      <!-- المخرجات -->
      <section class="card">
        <h2>النتائج</h2>
        <div class="kpis">
          <div class="kpi"><div class="v" id="t_total">—</div><div class="l">الزمن الكلي</div></div>
          <div class="kpi"><div class="v" id="t1">—</div><div class="l">تبريد حتى التجمد</div></div>
          <div class="kpi"><div class="v" id="t2">—</div><div class="l">مرحلة التجميد</div></div>
          <div class="kpi"><div class="v" id="t3">—</div><div class="l">تبريد تحت التجمد</div></div>
        </div>

        <div class="timeline">
          <div class="bar" id="bar">
            <div class="seg cool" id="seg1" style="left:0;width:0%"></div>
            <div class="seg freeze" id="seg2" style="left:0;width:0%"></div>
            <div class="seg sub" id="seg3" style="left:0;width:0%"></div>
          </div>
          <div class="legend">
            <span><i class="sw" style="background:#60a5fa"></i> تبريد فوق نقطة التجمد</span>
            <span><i class="sw" style="background:#22d3ee"></i> تجميد (تحوّل طوري)</span>
            <span><i class="sw" style="background:#a78bfa"></i> تبريد تحت التجمد</span>
          </div>
          <div id="status" class="status">—</div>
        </div>

        <div class="card" style="margin-top:12px">
          <h2>خصائص المادة (قابلة للتعديل)</h2>
          <div class="split">
            <div>
              <div class="field"><label>الكثافة ρ (كغ/م³)</label><input id="rho" type="number" step="1" value="1060"></div>
              <div class="field"><label>نقطة التجمد/الانصهار T<sub>f</sub> (°م)</label><input id="Tf" type="number" step="0.1" value="-1.5"></div>
              <div class="field"><label>حرارة كامنة L (كج/كغ)</label><input id="Lh" type="number" step="1" value="250"></div>
            </div>
            <div>
              <div class="field"><label>حرارة نوعية فوق التجمد c<sub>u</sub> (كج/كغ·ك)</label><input id="cu" type="number" step="0.01" value="3.2"></div>
              <div class="field"><label>حرارة نوعية تحت التجمد c<sub>f</sub> (كج/كغ·ك)</label><input id="cf" type="number" step="0.01" value="1.7"></div>
              <div class="field"><label>موصلية حرارية k (و/م·ك)</label><input id="k" type="number" step="0.01" value="1.5"></div>
            </div>
          </div>
          <div class="help">اختيارات افتراضية تقريبية للمنتجات عالية الرطوبة. عدّل حسب نوع المنتج والرطوبة للمزيد من الدقة.</div>
        </div>
      </section>
    </div>

    <footer>
      <div>💡 جرّب تغيير السماكة/الأبعاد ولاحظ أن الزمن يتناسب تقريباً مع مربع البُعد المميّز.</div>
      <div>© أداة تعليمية</div>
    </footer>
  </div>

  <script>
    // قاعدة بيانات مبسطة لخصائص بعض الأغذية (قِيَم تقريبية)
    const FOODS = {
      beef:   { rho: 1050, Tf: -1.8, Lh: 230, cu: 3.1, cf: 1.6, k: 1.4 },
      chicken:{ rho: 1080, Tf: -2.2, Lh: 240, cu: 3.2, cf: 1.7, k: 1.4 },
      fish:   { rho: 1060, Tf: -1.0, Lh: 250, cu: 3.6, cf: 1.9, k: 1.3 },
      bread:  { rho: 450,  Tf: -5.0, Lh: 150, cu: 2.3, cf: 1.3, k: 0.3 },
      strawberry:{ rho: 980, Tf: -1.2, Lh: 260, cu: 3.8, cf: 1.9, k: 0.6 },
      peas:   { rho: 910,  Tf: -1.8, Lh: 250, cu: 3.6, cf: 1.8, k: 0.5 },
      icecream:{ rho: 560, Tf: -2.5, Lh: 210, cu: 2.2, cf: 1.9, k: 0.5 },
      custom: { rho: 1060, Tf: -1.5, Lh: 250, cu: 3.2, cf: 1.7, k: 1.5 }
    };

    const airflowH = { // معاملات انتقال حراري تقريبية (و/م²·ك)
      low: 6,
      med: 12,
      high: 25
    };

    const packFactor = { // تخفيض h بسبب التغليف
      bare: 1.0,
      wrap: 0.7,
      box: 0.45
    };

    // عناصر DOM
    const el = id => document.getElementById(id);
    const foodSel = el('food');
    const Tair = el('Tair');
    const Tinit = el('Tinit');
    const Ttarget = el('Ttarget');
    const shapeSel = el('shape');
    const packSel = el('pack');
    const airflowSel = el('airflow');
    const safety = el('safety');

    const tTotal = el('t_total');
    const t1Out = el('t1');
    const t2Out = el('t2');
    const t3Out = el('t3');
    const seg1 = el('seg1');
    const seg2 = el('seg2');
    const seg3 = el('seg3');
    const status = el('status');

    // خصائص المادة (قابلة للتعديل)
    const rho = el('rho');
    const Tf = el('Tf');
    const Lh = el('Lh');
    const cu = el('cu');
    const cf = el('cf');
    const k = el('k');

    function loadFoodProps(){
      const f = FOODS[foodSel.value];
      if(!f) return;
      rho.value = f.rho; Tf.value = f.Tf; Lh.value = f.Lh; cu.value = f.cu; cf.value = f.cf; k.value = f.k;
    }

    // تحديث حقول الأبعاد بحسب الشكل
    function updateDimsUI(){
      const shape = shapeSel.value;
      [...document.querySelectorAll('.slab-only')].forEach(n=>n.style.display = shape==='slab' ? '' : 'none');
      [...document.querySelectorAll('.cyl-only')].forEach(n=>n.style.display = shape==='cylinder' ? '' : 'none');
      [...document.querySelectorAll('.sph-only')].forEach(n=>n.style.display = shape==='sphere' ? '' : 'none');
    }

    // أدوات هندسية
    function geom(shape){
      // تُرجع الحجم (م³) والمساحة السطحية (م²) والبُعد المميز (م)
      if(shape==='slab'){
        const Lcm = parseFloat(el('L').value)||0, Wcm=parseFloat(el('W').value)||0, Tcm=parseFloat(el('T').value)||0;
        const Lm=Lcm/100, Wm=Wcm/100, Tm=Tcm/100;
        const V = Lm*Wm*Tm;
        const A = 2*(Lm*Wm + Lm*Tm + Wm*Tm);
        const Dchar = Tm; // للسلايسات السمك هو البعد المسيطر
        return {V,A,Dchar};
      }
      if(shape==='cylinder'){
        const Dcm=parseFloat(el('D').value)||0, Hcm=parseFloat(el('H').value)||0;
        const Rm=(Dcm/100)/2, Hm=Hcm/100;
        const V = Math.PI*Rm*Rm*Hm;
        const A = 2*Math.PI*Rm*Rm + 2*Math.PI*Rm*Hm;
        const Dchar = Math.min(2*Rm,Hm); // تقريبي
        return {V,A,Dchar};
      }
      if(shape==='sphere'){
        const Dcm=parseFloat(el('Ds').value)||0; const Rm=(Dcm/100)/2;
        const V = 4/3*Math.PI*Math.pow(Rm,3);
        const A = 4*Math.PI*Math.pow(Rm,2);
        const Dchar = 2*Rm; // القطر
        return {V,A,Dchar};
      }
      return {V:0,A:0,Dchar:0};
    }

    function fmtMinutes(mins){
      if(!isFinite(mins) || mins<=0) return '—';
      const h = Math.floor(mins/60);
      const m = Math.round(mins%60);
      if(h<=0) return `${m} د`;
      return `${h} س ${m} د`;
    }

    function clamp(val,min,max){return Math.max(min,Math.min(max,val));}

    function calc(){
      const props = {
        rho: parseFloat(rho.value),
        Tf: parseFloat(Tf.value),
        Lh: parseFloat(Lh.value)*1000, // إلى جول/كغ
        cu: parseFloat(cu.value)*1000, // إلى جول/كغ·ك
        cf: parseFloat(cf.value)*1000,
        k:  parseFloat(k.value)
      };

      const Ta = parseFloat(Tair.value);
      const Ti = parseFloat(Tinit.value);
      const Tt = parseFloat(Ttarget.value);
      const {V,A,Dchar} = geom(shapeSel.value);

      if(V<=0 || A<=0){
        status.className='status bad';
        status.textContent='أدخل أبعاداً صحيحة.';
        [tTotal,t1Out,t2Out,t3Out].forEach(n=>n.textContent='—');
        [seg1,seg2,seg3].forEach(n=>n.style.width='0%');
        return;
      }

      // الكتلة
      const m = props.rho * V; // كغ

      // تقدير h (و/م²·ك)
      const hBase = airflowH[airflowSel.value] || 10;
      const h = hBase * (packFactor[packSel.value]||1);

      // تحقق قابلية التجميد
      if(Ta >= props.Tf){
        status.className='status bad';
        status.textContent='⚠️ لن يحدث تجميد لأن هواء المجمد أعلى من/قريب جداً من نقطة تجمد المادة.';
      }

      // المرحلة 1: تبريد من Ti إلى Tf (إن كان Ti>Tf)
      let t1 = 0; // ثانية
      if(Ti > props.Tf){
        const num = m * props.cu;
        const arg = (Ti - Ta) / (props.Tf - Ta);
        if(arg>1){ // log موجب
          t1 = (num/(h*A)) * Math.log(arg);
        }
      }

      // المرحلة 2: تجميد عند Tf (تحول طوري)
      // تقريب: معدل إزالة الحرارة Qdot = h*A*(Tf - Ta_eff) حيث Ta_eff = Ta
      // الزمن = m*L / (h*A*ΔT_eff)
      let t2 = 0;
      const dT2 = Math.max( (props.Tf - Ta), 0.5 ); // لا نجعلها صفراً لتجنب لانهاية
      t2 = (m * props.Lh) / (h * A * dT2);

      // المرحلة 3: تبريد من Tf إلى Tt (إن كان Tt<Tf)
      let t3 = 0;
      if(Tt < props.Tf){
        const num = m * props.cf;
        const arg = (props.Tf - Ta) / (Tt - Ta);
        if(arg>1){ t3 = (num/(h*A)) * Math.log(arg); }
      }

      // معامل أمان
      const safetyFactor = 1 + (parseFloat(safety.value)||0)/100;
      t1 *= safetyFactor; t2 *= safetyFactor; t3 *= safetyFactor;

      // إلى دقائق
      const t1m = t1/60, t2m = t2/60, t3m = t3/60;
      const total = t1m + t2m + t3m;

      // عرض النتائج
      t1Out.textContent = fmtMinutes(t1m);
      t2Out.textContent = fmtMinutes(t2m);
      t3Out.textContent = fmtMinutes(t3m);
      tTotal.textContent = fmtMinutes(total);

      // شريط زمني
      const s1 = total>0 ? (t1m/total)*100 : 0;
      const s2 = total>0 ? (t2m/total)*100 : 0;
      const s3 = total>0 ? (t3m/total)*100 : 0;
      seg1.style.width = s1+'%';
      seg2.style.left = s1+'%'; seg2.style.width = s2+'%';
      seg3.style.left = (s1+s2)+'%'; seg3.style.width = s3+'%';

      // تعليق حالة
      let msg = '—'; let cls = 'status';
      if(total>0){
        if(total<=60) { msg = '⏱️ تجميد سريع نسبياً.'; cls+=' good'; }
        else if(total<=240){ msg = '🧊 زمن متوسط — حسن تدفق الهواء وخفّف السماكة لتسريع العملية.'; cls+=' warn'; }
        else { msg = '🐢 تجميد بطيء — فكّر بتقليل البعد المميّز أو خفّض درجة حرارة الهواء.'; cls+=' bad'; }
      }
      status.className = cls; status.textContent = msg + ` | h≈${h.toFixed(1)} و/م²·ك | كتلة≈${m.toFixed(2)} كغ`;

      // إرجاع النتائج للاستخدام في التصدير
      return {t1m,t2m,t3m,total,h,m,geom: {V,A,Dchar}};
    }

    // أحداث
    foodSel.addEventListener('change', ()=>{ loadFoodProps(); calc(); syncURL(); });
    shapeSel.addEventListener('change', ()=>{ updateDimsUI(); calc(); syncURL(); });
    [Tair,Tinit,Ttarget,packSel,airflowSel,safety,rho,Tf,Lh,cu,cf,k,
     el('L'),el('W'),el('T'),el('D'),el('H'),el('Ds')].forEach(n=> n && n.addEventListener('input', ()=>{ calc(); syncURL(); }));

    // أزرار
    el('calc').addEventListener('click', ()=>{ calc(); });
    el('reset').addEventListener('click', ()=>{ location.href = location.pathname; });

    // تصدير CSV
    el('exportCsv').addEventListener('click', ()=>{
      const r = calc(); if(!r) return;
      const rows = [
        ['البند','القيمة'],
        ['زمن التبريد حتى التجمد', fmtMinutes(r.t1m)],
        ['زمن التجميد', fmtMinutes(r.t2m)],
        ['زمن التبريد تحت التجمد', fmtMinutes(r.t3m)],
        ['الزمن الكلي', fmtMinutes(r.total)],
        ['h (و/م²·ك)', r.h.toFixed(2)],
        ['الكتلة (كغ)', r.m.toFixed(3)],
      ];
      const csv = rows.map(r=>r.join(',')).join('\n');
      const blob = new Blob(["\uFEFF"+csv], {type:'text/csv;charset=utf-8;'});
      const a = document.createElement('a');
      a.href = URL.createObjectURL(blob);
      a.download = 'freezing-time-results.csv';
      a.click();
    });

    // مشاركة الإعدادات عبر الرابط (query string)
    function syncURL(){
      const params = new URLSearchParams();
      params.set('food', foodSel.value);
      params.set('Tair', Tair.value);
      params.set('Tinit', Tinit.value);
      params.set('Ttarget', Ttarget.value);
      params.set('shape', shapeSel.value);
      params.set('pack', packSel.value);
      params.set('air', airflowSel.value);
      params.set('safe', safety.value);
      ['L','W','T','D','H','Ds','rho','Tf','Lh','cu','cf','k'].forEach(id=>{
        const v = el(id); if(v) params.set(id, v.value);
      });
      history.replaceState(null,'','?'+params.toString());
    }

    function loadFromURL(){
      const q = new URLSearchParams(location.search);
      const set = (id,key=id)=>{const v=q.get(key); if(v!==null){const node=el(id); if(node){node.value=v;}}}
      set('food'); set('Tair'); set('Tinit'); set('Ttarget'); set('shape'); set('pack'); set('airflow','air'); set('safety','safe');
      set('L'); set('W'); set('T'); set('D'); set('H'); set('Ds');
      set('rho'); set('Tf'); set('Lh'); set('cu'); set('cf'); set('k');
      updateDimsUI(); if(q.get('food')) loadFoodProps();
    }

    el('share').addEventListener('click', ()=>{
      syncURL();
      navigator.clipboard.writeText(location.href).then(()=>{
        const label = document.getElementById('presetLabel');
        label.textContent = 'تم نسخ الرابط ✅';
        setTimeout(()=>label.textContent='إعدادات افتراضية آمنة',1500);
      });
    });

    // تهيئة
    loadFoodProps();
    updateDimsUI();
    loadFromURL();
    calc();
  </script>
</body>
</html>
